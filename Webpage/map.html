<!DOCTYPE html>
<html>
	<head onload="startMapUpdate()">
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
		<title>Kerbal Maps</title>
		<!-- TODO: Remove unused stuff -->
		<link rel="stylesheet" type="text/css" href="css/leafletksp.css" />
		<link rel="stylesheet" href="css/jKSPWAPICore.css" />
		<script type="text/javascript" src="js/leafletksp.js"></script>
		<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
		<script type="text/javascript" src="js/jKSPWAPICore.js"></script>
		<script>
    	var UpdateMarkerJSON = JSON.parse('{"Main":{"ID":[[10,10, 13, "1000/10", 3000, "NOT A REAL SHIP", "Debris", "0154348e-2ac9-4401-92b1-3df5a4e3f650"],[-10,-10, 13, "100/10", 3000, "NOT A REAL SHIP", "SpaceObject", "d708e8e6-9c67-4fcb-ab01-283e2e2ba858"]]}}')
        
    async function startMapUpdate() {
        while (true) {
        	const result = await updateMap();
  			resetMap()
  			try {
  			UpdateMarkerJSON.Main.ID.forEach((element) => {
  			if (element[0] != "nil") {
 				var Heights = element[3].toString().split("/")
 				//https://kerbalspaceprogram.com/api/_vessel_8cs.html#afa39c7ec7cc0926b332fcd2d77425edb
 				if (element[6] == "Debris") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.DEBRIS}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + Math.round(Heights[0]) + "m / " + Math.round(Heights[1]) + "m<br>Velocity: " + Math.round(element[4]) + "m/s<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "D", element[2])
 				} else if (element[6] == "SpaceObject") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELSpaceObject}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + Math.round(Heights[0]) + "m / " + Math.round(Heights[1]) + "m<br>Velocity: " + Math.round(element[4]) + "m/s<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				} else if (element[6] == "Probe") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELProbe}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + Math.round(Heights[0]) + "m / " + Math.round(Heights[1]) + "m<br>Velocity: " + Math.round(element[4]) + "m/s<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				} else if (element[6] == "Relay") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELRelay}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + Math.round(Heights[0]) + "m / " + Math.round(Heights[1]) + "m<br>Velocity: " + Math.round(element[4]) + "m/s<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				} else if (element[6] == "Rover") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELRover}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + Math.round(Heights[0]) + "m / " + Math.round(Heights[1]) + "m<br>Velocity: " + Math.round(element[4]) + "m/s<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				} else if (element[6] == "Lander") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELLander}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + Math.round(Heights[0]) + "m / " + Math.round(Heights[1]) + "m<br>Velocity: " + Math.round(element[4]) + "m/s<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				} else if (element[6] == "Ship") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELShip}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + Math.round(Heights[0]) + "m / " + Math.round(Heights[1]) + "m<br>Velocity: " + Math.round(element[4]) + "m/s<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				} else if (element[6] == "Plane") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELPlane}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + Math.round(Heights[0]) + "m / " + Math.round(Heights[1]) + "m<br>Velocity: " + Math.round(element[4]) + "m/s<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				} else if (element[6] == "Station") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELStation}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + Math.round(Heights[0]) + "m / " + Math.round(Heights[1]) + "m<br>Velocity: " + Math.round(element[4]) + "m/s<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				} else if (element[6] == "Base") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELBase}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + Math.round(Heights[0]) + "m / " + Math.round(Heights[1]) + "m<br>Velocity: " + Math.round(element[4]) + "m/s<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				} else if (element[6] == "EVA") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELEVA}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + Math.round(Heights[0]) + "m / " + Math.round(Heights[1]) + "m<br>Velocity: " + Math.round(element[4]) + "m/s<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				} else if (element[6] == "Flag") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELFlag}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + Math.round(Heights[0]) + "m / " + Math.round(Heights[1]) + "m<br>Velocity: " + Math.round(element[4]) + "m/s<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				} else if (element[6] == "DeployedScienceController") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELDeployedScienceController}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + Math.round(Heights[0]) + "m / " + Math.round(Heights[1]) + "m<br>Velocity: " + Math.round(element[4]) + "m/s<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				} else if (element[6] == "DeployedSciencePart") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELDeployedSciencePart}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + Math.round(Heights[0]) + "m / " + Math.round(Heights[1]) + "m<br>Velocity: " + Math.round(element[4]) + "m/s<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				} else {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELUnknown}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + Math.round(Heights[0]) + "m / " + Math.round(Heights[1]) + "m<br>Velocity: " + Math.round(element[4]) + "m/s<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				}
 				
 			} else {
 				console.warn("nil coordinate found, skipping marker!")
 				console.warn(element)
 			}
			})
			} catch(e) {
			console.warn("ERROR BELOW")
			console.error(e)
			console.warn("JSON BELOW")
			console.warn(UpdateMarkerJSON)
			}
  		}
    }
    
    //TODO: Orbit Body: https://wiki.kerbalspaceprogram.com/wiki/Orbit#Reference_code.
    function AddMarker(Marker, Type, Planet) {
    if (Type == "V") {
    if (Planet == 0) {
    //There is no map for the sun.
    } else if (Planet == 1) {
    Marker[0].addTo(L.KSP.CelestialBody.KERBIN.overlays.Vessels)
    } else if (Planet == 2) {
    Marker[0].addTo(L.KSP.CelestialBody.MUN.overlays.Vessels)
    } else if (Planet == 3) {
    Marker[0].addTo(L.KSP.CelestialBody.MINMUS.overlays.Vessels)
    } else if (Planet == 4) {
    Marker[0].addTo(L.KSP.CelestialBody.MOHO.overlays.Vessels)
    } else if (Planet == 5) {
    Marker[0].addTo(L.KSP.CelestialBody.EVE.overlays.Vessels)
    } else if (Planet == 6) {
    Marker[0].addTo(L.KSP.CelestialBody.DUNA.overlays.Vessels)
    } else if (Planet == 7) {
    Marker[0].addTo(L.KSP.CelestialBody.IKE.overlays.Vessels)
    } else if (Planet == 8) {
    //There is no map for jool.
    } else if (Planet == 9) {
    Marker[0].addTo(L.KSP.CelestialBody.LAYTHE.overlays.Vessels)
    } else if (Planet == 10) {
    Marker[0].addTo(L.KSP.CelestialBody.VALL.overlays.Vessels)
    } else if (Planet == 11) {
    Marker[0].addTo(L.KSP.CelestialBody.BOP.overlays.Vessels)
    } else if (Planet == 12) {
    Marker[0].addTo(L.KSP.CelestialBody.TYLO.overlays.Vessels)
    } else if (Planet == 13) {
    Marker[0].addTo(L.KSP.CelestialBody.GILLY.overlays.Vessels)
    } else if (Planet == 14) {
    Marker[0].addTo(L.KSP.CelestialBody.POL.overlays.Vessels)
    } else if (Planet == 15) {
    Marker[0].addTo(L.KSP.CelestialBody.DRES.overlays.Vessels)
    } else if (Planet == 16) {
    Marker[0].addTo(L.KSP.CelestialBody.EELOO.overlays.Vessels)
    } else {
    console.warn("UNKNOWN PLANET: " + Planet + ". Marker not added!")
    }
    } else if (Type == "D") {
    
    if (Planet == 0) {
    //There is no map for the sun.
    } else if (Planet == 1) {
    Marker[0].addTo(L.KSP.CelestialBody.KERBIN.overlays.Debris)
    } else if (Planet == 2) {
    Marker[0].addTo(L.KSP.CelestialBody.MUN.overlays.Debris)
    } else if (Planet == 3) {
    Marker[0].addTo(L.KSP.CelestialBody.MINMUS.overlays.Debris)
    } else if (Planet == 4) {
    Marker[0].addTo(L.KSP.CelestialBody.MOHO.overlays.Debris)
    } else if (Planet == 5) {
    Marker[0].addTo(L.KSP.CelestialBody.EVE.overlays.Debris)
    } else if (Planet == 6) {
    Marker[0].addTo(L.KSP.CelestialBody.DUNA.overlays.Debris)
    } else if (Planet == 7) {
    Marker[0].addTo(L.KSP.CelestialBody.IKE.overlays.Debris)
    } else if (Planet == 8) {
    //There is no map for jool.
    } else if (Planet == 9) {
    Marker[0].addTo(L.KSP.CelestialBody.LAYTHE.overlays.Debris)
    } else if (Planet == 10) {
    Marker[0].addTo(L.KSP.CelestialBody.VALL.overlays.Debris)
    } else if (Planet == 11) {
    Marker[0].addTo(L.KSP.CelestialBody.BOP.overlays.Debris)
    } else if (Planet == 12) {
    Marker[0].addTo(L.KSP.CelestialBody.TYLO.overlays.Debris)
    } else if (Planet == 13) {
    Marker[0].addTo(L.KSP.CelestialBody.GILLY.overlays.Debris)
    } else if (Planet == 14) {
    Marker[0].addTo(L.KSP.CelestialBody.POL.overlays.Debris)
    } else if (Planet == 15) {
    Marker[0].addTo(L.KSP.CelestialBody.DRES.overlays.Debris)
    } else if (Planet == 16) {
    Marker[0].addTo(L.KSP.CelestialBody.EELOO.overlays.Debris)
    } else {
    console.warn("UNKNOWN PLANET: " + Planet + ". Marker not added!")
    }
    } else {
	console.warn("UNKNOWN TYPE: " + Type + ". Marker not added!")
    }
    
    }
    
    
    
    //TODO: Update existing markers instead of replacing.
    function resetMap() {
    	L.KSP.CelestialBody.EELOO.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.EELOO.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.POL.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.POL.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.BOP.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.BOP.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.TYLO.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.TYLO.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.VALL.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.VALL.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.LAYTHE.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.LAYTHE.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.DRES.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.DRES.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.IKE.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.IKE.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.DUNA.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.DUNA.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.MINMUS.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.MINMUS.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.MUN.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.MUN.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.KERBIN.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.KERBIN.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.GILLY.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.GILLY.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.EVE.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.EVE.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.MOHO.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.MOHO.overlays.Vessels.clearLayers()
    }
    //Obtain JSON
    function updateMap() {
    return new Promise(resolve => {
    setTimeout(() => {
      var txtFile = new XMLHttpRequest();
    txtFile.onreadystatechange = function () {
    var allText = "";
        if (txtFile.readyState === XMLHttpRequest.DONE && txtFile.status == 200) {
        
            allText = txtFile.responseText;
            UpdateMarkerJSON = JSON.parse(allText);
}
        

    }
    var seconds = new Date().getTime() / 1000;
    txtFile.open("GET", 'https://jsonblob.com/api/jsonBlob/e7be982b-7620-11ea-84c8-85d74a3e24e7' + '?' + seconds, true);
    txtFile.send(null);
      resolve(UpdateMarkerJSON);
    }, 2000);
  });
    }
    
    function sleep(ms)
	{
    	var date = new Date();
  	  var curDate = null;
 	   do { curDate = new Date(); }
  	  while(curDate-date < ms);
	}
	
    //I have not touched this much
        function startMap() {
            var previousBody = -1;
            var newBody;
            jQuery(document).ready(function ($) {
                map = new L.KSP.Map('map', {
                    layers: [L.KSP.CelestialBody.KERBIN],
                    zoom: 1,
                    center: [-0.1027, -74.5754],
                    bodyControl: true,
                    layerControl: false,
                    scaleControl: true
                });
                map.fitWorld();
                rawData = [[0]];
                var i = 0;
				resetMap()
				document.getElementsByClassName("leaflet-control-attribution")[0].style.textAlign = "right"
    			document.getElementsByClassName("leaflet-control-attribution")[0].innerHTML = "<a target='_blank' href='https://github.com/FrostBird347/DMPServerMap/blob/master/Attributions.md#Map-Attributions'>Map attributions</a> - <a target='_blank' href='https://github.com/FrostBird347/DMPServerMap/blob/master/Attributions.md'>Full list of attributions</a><br>" + document.getElementsByClassName("leaflet-control-attribution")[0].innerHTML
				startMapUpdate()
				//Was used in telemachus, it might have something to do with orbit lines (looks like it requires long, lat, surface velocity though).
                /*jKSPWAPI.initPoll("longs=v.long&lat=v.lat&name=v.name&alt=v.altitude&m=v.surfaceVelocity&body=v.body", function (rawData) { }, function (rawData, d) {

                    if (previousBody != d.body) {
                        try {
                            newBody = L.KSP.CelestialBody[d.body.toUpperCase()];
                            newBody.addTo(map);
                            previousBody = d.body;
                        } catch (e) {
                            if (d.body === undefined) {
                                previousBody = d.body;
                            } else {
                                //alert("Body not supported yet. (" + d.body + ")")
                                previousBody = -1;
                            }
                            
                        }
                    }

                    if (!isNaN(d.lat) && !isNaN(d.longs)) {
                        marker[0].setLatLng([d.lat, (d.longs > 180 ? d.longs - 360.0 : d.longs)]);
                        marker[0].bindPopup(d.name + " 
									</br>Altitude: " + d.alt + "
								</br>Surface Velocity: " + d.m);
                        marker[0].update();
                    }
                }, rawData)*/
            });
        }
    
							</script>
						</head>
						<body onload="startMap();" style="padding: 0; margin: 0;">
							<div id="map" class="map" style="padding: 0; margin: 0; height: 100%;"></div>
						</body>
					</html>
