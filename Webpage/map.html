<!DOCTYPE html>
<html>
	<head onload="startMapUpdate()">
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
		<title>Kerbal Maps</title>
		<!-- TODO: Remove unused stuff -->
		<link rel="stylesheet" type="text/css" href="css/leafletksp.css" />
		<link rel="stylesheet" href="css/jKSPWAPICore.css" />
		<script type="text/javascript" src="js/leafletksp.js"></script>
		<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
		<script type="text/javascript" src="js/jKSPWAPICore.js"></script>
		<script type="text/javascript" src="./config/JSON.url"></script>
		<script>
    	var UpdateMarkerJSON = JSON.parse('{"Main":{"ID":[[10,10, 13, "1000/10", 3000, "NOT A REAL SHIP", "Debris", "0154348e-2ac9-4401-92b1-3df5a4e3f650"],[-10,-10, 13, "100/10", 3000, "NOT A REAL SHIP", "SpaceObject", "d708e8e6-9c67-4fcb-ab01-283e2e2ba858"]]}}')
        var JSONURL = getJSONUrl();
    async function startMapUpdate() {
        while (true) {
        	const result = await updateMap();
        	SetCredits()
  			resetMap()
  			try {
  			UpdateMarkerJSON.Main.ID.forEach((element) => {
  			if (element[0] != "nil" && element[0] != "NaN") {
  				//Height stuff
 				var height = Math.round(element[3])
 				var heightstatus = " m"
 				if (height > 1000000000) {
 				height = height / 10000000
 				height = Math.round(height)
 				height = height / 100
 				heightstatus = " Gm"
 				} else if  (height > 1000000) {
 				height = height / 10000
 				height = Math.round(height)
 				height = height / 100
 				heightstatus = " Mm"
 				} else if  (height > 1000) {
 				height = height / 10
 				height = Math.round(height)
 				height = height / 100
 				heightstatus = " km"
 				}
 				//Velocity stuff
 				var velocity = Math.round(element[4])
 				var velocitystatus = " m/s"
 				if (velocity > 1000000000) {
 				velocity = velocity / 10000000
 				velocity = Math.round(velocity)
 				velocity = velocity / 100
 				velocitystatus = " Gm/s"
 				} else if  (velocity > 1000000) {
 				velocity = velocity / 10000
 				velocity = Math.round(velocity)
 				velocity = velocity / 100
 				velocitystatus = " Mm/s"
 				} else if  (velocity > 1000) {
 				velocity = velocity / 10
 				velocity = Math.round(velocity)
 				velocity = velocity / 100
 				velocitystatus = " km/s"
 				}
 				//https://kerbalspaceprogram.com/api/_vessel_8cs.html#afa39c7ec7cc0926b332fcd2d77425edb
 				if (element[6] == "Debris") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.DEBRIS}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + height + heightstatus + "<br>Velocity: " + velocity + velocitystatus + "<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "D", element[2])
 				} else if (element[6] == "SpaceObject") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELSpaceObject}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + height + heightstatus + "<br>Velocity: " + velocity + velocitystatus + "<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "O", element[2])
 				} else if (element[6] == "Probe") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELProbe}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + height + heightstatus + "<br>Velocity: " + velocity + velocitystatus + "<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				} else if (element[6] == "Relay") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELRelay}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + height + heightstatus + "<br>Velocity: " + velocity + velocitystatus + "<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				} else if (element[6] == "Rover") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELRover}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + height + heightstatus + "<br>Velocity: " + velocity + velocitystatus + "<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				} else if (element[6] == "Lander") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELLander}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + height + heightstatus + "<br>Velocity: " + velocity + velocitystatus + "<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				} else if (element[6] == "Ship") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELShip}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + height + heightstatus + "<br>Velocity: " + velocity + velocitystatus + "<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				} else if (element[6] == "Plane") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELPlane}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + height + heightstatus + "<br>Velocity: " + velocity + velocitystatus + "<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				} else if (element[6] == "Station") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELStation}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + height + heightstatus + "<br>Velocity: " + velocity + velocitystatus + "<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				} else if (element[6] == "Base") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELBase}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + height + heightstatus + "<br>Velocity: " + velocity + velocitystatus + "<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				} else if (element[6] == "EVA") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELEVA}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + height + heightstatus + "<br>Velocity: " + velocity + velocitystatus + "<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "K", element[2])
 				} else if (element[6] == "Flag") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELFlag}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + height + heightstatus + "<br>Velocity: " + velocity + velocitystatus + "<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "F", element[2])
 				} else if (element[6] == "DeployedScienceController") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELDeployedScienceController}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + height + heightstatus + "<br>Velocity: " + velocity + velocitystatus + "<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				} else if (element[6] == "DeployedSciencePart") {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELDeployedSciencePart}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + height + heightstatus + "<br>Velocity: " + velocity + velocitystatus + "<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				} else {
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSELUnknown}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Altitude: " + height + heightstatus + "<br>Velocity: " + velocity + velocitystatus + "<br>Type: " + element[6])]; 
 				AddMarker(newmarker, "V", element[2])
 				}
 				
 			} else {
 				console.warn("nil or NaN coordinate found, skipping marker!")
 				console.warn(element)
 			}
			})
			} catch(e) {
			console.warn("ERROR BELOW")
			console.error(e)
			console.warn("JSON BELOW")
			console.warn(UpdateMarkerJSON)
			}
  		}
    }
    
    //TODO: Orbit Body: https://wiki.kerbalspaceprogram.com/wiki/Orbit#Reference_code.
    function AddMarker(Marker, Type, Planet) {
    if (Type == "V") {
    if (Planet == 0) {
    //There is no map for the sun.
    } else if (Planet == 1) {
    Marker[0].addTo(L.KSP.CelestialBody.KERBIN.overlays.Vessels)
    } else if (Planet == 2) {
    Marker[0].addTo(L.KSP.CelestialBody.MUN.overlays.Vessels)
    } else if (Planet == 3) {
    Marker[0].addTo(L.KSP.CelestialBody.MINMUS.overlays.Vessels)
    } else if (Planet == 4) {
    Marker[0].addTo(L.KSP.CelestialBody.MOHO.overlays.Vessels)
    } else if (Planet == 5) {
    Marker[0].addTo(L.KSP.CelestialBody.EVE.overlays.Vessels)
    } else if (Planet == 6) {
    Marker[0].addTo(L.KSP.CelestialBody.DUNA.overlays.Vessels)
    } else if (Planet == 7) {
    Marker[0].addTo(L.KSP.CelestialBody.IKE.overlays.Vessels)
    } else if (Planet == 8) {
    //There is no map for jool.
    } else if (Planet == 9) {
    Marker[0].addTo(L.KSP.CelestialBody.LAYTHE.overlays.Vessels)
    } else if (Planet == 10) {
    Marker[0].addTo(L.KSP.CelestialBody.VALL.overlays.Vessels)
    } else if (Planet == 11) {
    Marker[0].addTo(L.KSP.CelestialBody.BOP.overlays.Vessels)
    } else if (Planet == 12) {
    Marker[0].addTo(L.KSP.CelestialBody.TYLO.overlays.Vessels)
    } else if (Planet == 13) {
    Marker[0].addTo(L.KSP.CelestialBody.GILLY.overlays.Vessels)
    } else if (Planet == 14) {
    Marker[0].addTo(L.KSP.CelestialBody.POL.overlays.Vessels)
    } else if (Planet == 15) {
    Marker[0].addTo(L.KSP.CelestialBody.DRES.overlays.Vessels)
    } else if (Planet == 16) {
    Marker[0].addTo(L.KSP.CelestialBody.EELOO.overlays.Vessels)
    } else {
    console.warn("UNKNOWN PLANET: " + Planet + ". Marker not added!")
    }
    } else if (Type == "O") {
    if (Planet == 0) {
    //There is no map for the sun.
    } else if (Planet == 1) {
    Marker[0].addTo(L.KSP.CelestialBody.KERBIN.overlays.SpaceObjects)
    } else if (Planet == 2) {
    Marker[0].addTo(L.KSP.CelestialBody.MUN.overlays.SpaceObjects)
    } else if (Planet == 3) {
    Marker[0].addTo(L.KSP.CelestialBody.MINMUS.overlays.SpaceObjects)
    } else if (Planet == 4) {
    Marker[0].addTo(L.KSP.CelestialBody.MOHO.overlays.SpaceObjects)
    } else if (Planet == 5) {
    Marker[0].addTo(L.KSP.CelestialBody.EVE.overlays.SpaceObjects)
    } else if (Planet == 6) {
    Marker[0].addTo(L.KSP.CelestialBody.DUNA.overlays.SpaceObjects)
    } else if (Planet == 7) {
    Marker[0].addTo(L.KSP.CelestialBody.IKE.overlays.SpaceObjects)
    } else if (Planet == 8) {
    //There is no map for jool.
    } else if (Planet == 9) {
    Marker[0].addTo(L.KSP.CelestialBody.LAYTHE.overlays.SpaceObjects)
    } else if (Planet == 10) {
    Marker[0].addTo(L.KSP.CelestialBody.VALL.overlays.SpaceObjects)
    } else if (Planet == 11) {
    Marker[0].addTo(L.KSP.CelestialBody.BOP.overlays.SpaceObjects)
    } else if (Planet == 12) {
    Marker[0].addTo(L.KSP.CelestialBody.TYLO.overlays.SpaceObjects)
    } else if (Planet == 13) {
    Marker[0].addTo(L.KSP.CelestialBody.GILLY.overlays.SpaceObjects)
    } else if (Planet == 14) {
    Marker[0].addTo(L.KSP.CelestialBody.POL.overlays.SpaceObjects)
    } else if (Planet == 15) {
    Marker[0].addTo(L.KSP.CelestialBody.DRES.overlays.SpaceObjects)
    } else if (Planet == 16) {
    Marker[0].addTo(L.KSP.CelestialBody.EELOO.overlays.SpaceObjects)
    } else {
    console.warn("UNKNOWN PLANET: " + Planet + ". Marker not added!")
    }
    } else if (Type == "K") {
    if (Planet == 0) {
    //There is no map for the sun.
    } else if (Planet == 1) {
    Marker[0].addTo(L.KSP.CelestialBody.KERBIN.overlays.Kerbals)
    } else if (Planet == 2) {
    Marker[0].addTo(L.KSP.CelestialBody.MUN.overlays.Kerbals)
    } else if (Planet == 3) {
    Marker[0].addTo(L.KSP.CelestialBody.MINMUS.overlays.Kerbals)
    } else if (Planet == 4) {
    Marker[0].addTo(L.KSP.CelestialBody.MOHO.overlays.Kerbals)
    } else if (Planet == 5) {
    Marker[0].addTo(L.KSP.CelestialBody.EVE.overlays.Kerbals)
    } else if (Planet == 6) {
    Marker[0].addTo(L.KSP.CelestialBody.DUNA.overlays.Kerbals)
    } else if (Planet == 7) {
    Marker[0].addTo(L.KSP.CelestialBody.IKE.overlays.Kerbals)
    } else if (Planet == 8) {
    //There is no map for jool.
    } else if (Planet == 9) {
    Marker[0].addTo(L.KSP.CelestialBody.LAYTHE.overlays.Kerbals)
    } else if (Planet == 10) {
    Marker[0].addTo(L.KSP.CelestialBody.VALL.overlays.Kerbals)
    } else if (Planet == 11) {
    Marker[0].addTo(L.KSP.CelestialBody.BOP.overlays.Kerbals)
    } else if (Planet == 12) {
    Marker[0].addTo(L.KSP.CelestialBody.TYLO.overlays.Kerbals)
    } else if (Planet == 13) {
    Marker[0].addTo(L.KSP.CelestialBody.GILLY.overlays.Kerbals)
    } else if (Planet == 14) {
    Marker[0].addTo(L.KSP.CelestialBody.POL.overlays.Kerbals)
    } else if (Planet == 15) {
    Marker[0].addTo(L.KSP.CelestialBody.DRES.overlays.Kerbals)
    } else if (Planet == 16) {
    Marker[0].addTo(L.KSP.CelestialBody.EELOO.overlays.Kerbals)
    } else {
    console.warn("UNKNOWN PLANET: " + Planet + ". Marker not added!")
    }
    } else if (Type == "F") {
    if (Planet == 0) {
    //There is no map for the sun.
    } else if (Planet == 1) {
    Marker[0].addTo(L.KSP.CelestialBody.KERBIN.overlays.Flags)
    } else if (Planet == 2) {
    Marker[0].addTo(L.KSP.CelestialBody.MUN.overlays.Flags)
    } else if (Planet == 3) {
    Marker[0].addTo(L.KSP.CelestialBody.MINMUS.overlays.Flags)
    } else if (Planet == 4) {
    Marker[0].addTo(L.KSP.CelestialBody.MOHO.overlays.Flags)
    } else if (Planet == 5) {
    Marker[0].addTo(L.KSP.CelestialBody.EVE.overlays.Flags)
    } else if (Planet == 6) {
    Marker[0].addTo(L.KSP.CelestialBody.DUNA.overlays.Flags)
    } else if (Planet == 7) {
    Marker[0].addTo(L.KSP.CelestialBody.IKE.overlays.Flags)
    } else if (Planet == 8) {
    //There is no map for jool.
    } else if (Planet == 9) {
    Marker[0].addTo(L.KSP.CelestialBody.LAYTHE.overlays.Flags)
    } else if (Planet == 10) {
    Marker[0].addTo(L.KSP.CelestialBody.VALL.overlays.Flags)
    } else if (Planet == 11) {
    Marker[0].addTo(L.KSP.CelestialBody.BOP.overlays.Flags)
    } else if (Planet == 12) {
    Marker[0].addTo(L.KSP.CelestialBody.TYLO.overlays.Flags)
    } else if (Planet == 13) {
    Marker[0].addTo(L.KSP.CelestialBody.GILLY.overlays.Flags)
    } else if (Planet == 14) {
    Marker[0].addTo(L.KSP.CelestialBody.POL.overlays.Flags)
    } else if (Planet == 15) {
    Marker[0].addTo(L.KSP.CelestialBody.DRES.overlays.Flags)
    } else if (Planet == 16) {
    Marker[0].addTo(L.KSP.CelestialBody.EELOO.overlays.Flags)
    } else {
    console.warn("UNKNOWN PLANET: " + Planet + ". Marker not added!")
    }
    } else if (Type == "D") {
    
    if (Planet == 0) {
    //There is no map for the sun.
    } else if (Planet == 1) {
    Marker[0].addTo(L.KSP.CelestialBody.KERBIN.overlays.Debris)
    } else if (Planet == 2) {
    Marker[0].addTo(L.KSP.CelestialBody.MUN.overlays.Debris)
    } else if (Planet == 3) {
    Marker[0].addTo(L.KSP.CelestialBody.MINMUS.overlays.Debris)
    } else if (Planet == 4) {
    Marker[0].addTo(L.KSP.CelestialBody.MOHO.overlays.Debris)
    } else if (Planet == 5) {
    Marker[0].addTo(L.KSP.CelestialBody.EVE.overlays.Debris)
    } else if (Planet == 6) {
    Marker[0].addTo(L.KSP.CelestialBody.DUNA.overlays.Debris)
    } else if (Planet == 7) {
    Marker[0].addTo(L.KSP.CelestialBody.IKE.overlays.Debris)
    } else if (Planet == 8) {
    //There is no map for jool.
    } else if (Planet == 9) {
    Marker[0].addTo(L.KSP.CelestialBody.LAYTHE.overlays.Debris)
    } else if (Planet == 10) {
    Marker[0].addTo(L.KSP.CelestialBody.VALL.overlays.Debris)
    } else if (Planet == 11) {
    Marker[0].addTo(L.KSP.CelestialBody.BOP.overlays.Debris)
    } else if (Planet == 12) {
    Marker[0].addTo(L.KSP.CelestialBody.TYLO.overlays.Debris)
    } else if (Planet == 13) {
    Marker[0].addTo(L.KSP.CelestialBody.GILLY.overlays.Debris)
    } else if (Planet == 14) {
    Marker[0].addTo(L.KSP.CelestialBody.POL.overlays.Debris)
    } else if (Planet == 15) {
    Marker[0].addTo(L.KSP.CelestialBody.DRES.overlays.Debris)
    } else if (Planet == 16) {
    Marker[0].addTo(L.KSP.CelestialBody.EELOO.overlays.Debris)
    } else {
    console.warn("UNKNOWN PLANET: " + Planet + ". Marker not added!")
    }
    } else {
	console.warn("UNKNOWN TYPE: " + Type + ". Marker not added!")
    }
    
    }
    
    
    
    //TODO: Update existing markers instead of replacing.
    function resetMap() {
    	L.KSP.CelestialBody.EELOO.overlays.Flags.clearLayers()
		L.KSP.CelestialBody.EELOO.overlays.SpaceObjects.clearLayers()
		L.KSP.CelestialBody.POL.overlays.Flags.clearLayers()
		L.KSP.CelestialBody.POL.overlays.SpaceObjects.clearLayers()
		L.KSP.CelestialBody.BOP.overlays.Flags.clearLayers()
		L.KSP.CelestialBody.BOP.overlays.SpaceObjects.clearLayers()
		L.KSP.CelestialBody.TYLO.overlays.Flags.clearLayers()
		L.KSP.CelestialBody.TYLO.overlays.SpaceObjects.clearLayers()
		L.KSP.CelestialBody.VALL.overlays.Flags.clearLayers()
		L.KSP.CelestialBody.VALL.overlays.SpaceObjects.clearLayers()
		L.KSP.CelestialBody.LAYTHE.overlays.Flags.clearLayers()
		L.KSP.CelestialBody.LAYTHE.overlays.SpaceObjects.clearLayers()
		L.KSP.CelestialBody.DRES.overlays.Flags.clearLayers()
		L.KSP.CelestialBody.DRES.overlays.SpaceObjects.clearLayers()
		L.KSP.CelestialBody.IKE.overlays.Flags.clearLayers()
		L.KSP.CelestialBody.IKE.overlays.SpaceObjects.clearLayers()
		L.KSP.CelestialBody.DUNA.overlays.Flags.clearLayers()
		L.KSP.CelestialBody.DUNA.overlays.SpaceObjects.clearLayers()
		L.KSP.CelestialBody.MINMUS.overlays.Flags.clearLayers()
		L.KSP.CelestialBody.MINMUS.overlays.SpaceObjects.clearLayers()
		L.KSP.CelestialBody.MUN.overlays.Flags.clearLayers()
		L.KSP.CelestialBody.MUN.overlays.SpaceObjects.clearLayers()
		L.KSP.CelestialBody.KERBIN.overlays.Flags.clearLayers()
		L.KSP.CelestialBody.KERBIN.overlays.SpaceObjects.clearLayers()
		L.KSP.CelestialBody.GILLY.overlays.Flags.clearLayers()
		L.KSP.CelestialBody.GILLY.overlays.SpaceObjects.clearLayers()
		L.KSP.CelestialBody.EVE.overlays.Flags.clearLayers()
		L.KSP.CelestialBody.EVE.overlays.SpaceObjects.clearLayers()
		L.KSP.CelestialBody.MOHO.overlays.Flags.clearLayers()
		L.KSP.CelestialBody.MOHO.overlays.SpaceObjects.clearLayers()
    	L.KSP.CelestialBody.EELOO.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.EELOO.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.POL.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.POL.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.BOP.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.BOP.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.TYLO.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.TYLO.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.VALL.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.VALL.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.LAYTHE.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.LAYTHE.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.DRES.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.DRES.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.IKE.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.IKE.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.DUNA.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.DUNA.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.MINMUS.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.MINMUS.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.MUN.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.MUN.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.KERBIN.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.KERBIN.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.GILLY.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.GILLY.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.EVE.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.EVE.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.MOHO.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.MOHO.overlays.Vessels.clearLayers()
    	L.KSP.CelestialBody.EELOO.overlays.Kerbals.clearLayers()
		L.KSP.CelestialBody.POL.overlays.Kerbals.clearLayers()
		L.KSP.CelestialBody.BOP.overlays.Kerbals.clearLayers()
		L.KSP.CelestialBody.TYLO.overlays.Kerbals.clearLayers()
		L.KSP.CelestialBody.VALL.overlays.Kerbals.clearLayers()
		L.KSP.CelestialBody.LAYTHE.overlays.Kerbals.clearLayers()
		L.KSP.CelestialBody.DRES.overlays.Kerbals.clearLayers()
		L.KSP.CelestialBody.IKE.overlays.Kerbals.clearLayers()
		L.KSP.CelestialBody.DUNA.overlays.Kerbals.clearLayers()
		L.KSP.CelestialBody.MINMUS.overlays.Kerbals.clearLayers()
		L.KSP.CelestialBody.MUN.overlays.Kerbals.clearLayers()
		L.KSP.CelestialBody.KERBIN.overlays.Kerbals.clearLayers()
		L.KSP.CelestialBody.GILLY.overlays.Kerbals.clearLayers()
		L.KSP.CelestialBody.EVE.overlays.Kerbals.clearLayers()
		L.KSP.CelestialBody.MOHO.overlays.Kerbals.clearLayers()
    }
    //Obtain JSON
    function updateMap() {
    return new Promise(resolve => {
    setTimeout(() => {
    var txtFile = new XMLHttpRequest();
    txtFile.onreadystatechange = function () {
    	var allText = "";
        if (txtFile.readyState === XMLHttpRequest.DONE && txtFile.status == 200) {
            allText = txtFile.responseText;
            UpdateMarkerJSON = JSON.parse(allText);
            if (JSONURL == "https://jsonblob.com/api/jsonBlob/e7be982b-7620-11ea-84c8-85d74a3e24e7") {
            	console.error("\n---\nJSON obtained from https://jsonblob.com/e7be982b-7620-11ea-84c8-85d74a3e24e7\nThe url saved in the './JSON.url' file should be changed ASAP.\n---")
            }
		}
    }
    var seconds = new Date().getTime() / 1000;
    txtFile.open("GET", JSONURL + '?' + seconds, true);
    txtFile.send(null);
    resolve(UpdateMarkerJSON);
    }, 2000);
  });
    }
    
    function sleep(ms) {
    	var date = new Date();
  	  var curDate = null;
 	   do { curDate = new Date(); }
  	  while(curDate-date < ms);
	}
	
	function getJSONUrl() {
		try {
			var returnstring = GetRemoteJSONUrl()
			if (returnstring == undefined ) {
				console.error("Failed to get JSON URL, using default JSON URL instead!")
				return "https://jsonblob.com/api/jsonBlob/e7be982b-7620-11ea-84c8-85d74a3e24e7"
			} else {
				return returnstring
			}
		} catch {
			console.error("Failed to get JSON URL, using the default JSON URL instead!")
			return "https://jsonblob.com/api/jsonBlob/e7be982b-7620-11ea-84c8-85d74a3e24e7"
		}
	}
	
    //I have not touched this much
        function startMap() {
            var previousBody = -1;
            var newBody;
            jQuery(document).ready(function ($) {
                map = new L.KSP.Map('map', {
                    layers: [L.KSP.CelestialBody.KERBIN],
                    zoom: 1,
                    center: [-0.1027, -74.5754],
                    bodyControl: true,
                    layerControl: false,
                    scaleControl: true
                });
                map.fitWorld();
                rawData = [[0]];
                var i = 0;
				resetMap()
				startMapUpdate()
				
            });
        }
        
        function SetCredits() {
				document.getElementsByClassName("leaflet-control-attribution")[0].style.textAlign = "right"
    			document.getElementsByClassName("leaflet-control-attribution")[0].innerHTML = "<a target='_blank' href='https://github.com/FrostBird347/DMPServerMap/blob/master/Attributions.md#Map-Attributions'>Map attributions</a> - <a target='_blank' href='https://github.com/FrostBird347/DMPServerMap/blob/master/Attributions.md'>Full list of attributions</a><br>" + "Powered by <a href='http://leafletjs.com'>Leaflet</a> — Map data © Joel Pedraza"
        }
    
							</script>
						</head>
						<body onload="startMap();" style="padding: 0; margin: 0;">
							<div id="map" class="map" style="padding: 0; margin: 0; height: 100%;"></div>
						</body>
					</html>
