<!DOCTYPE html>
<html>
	<head onload="startMapUpdate()">
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
		<title>Kerbal Maps</title>
		<!-- TODO: Remove unused stuff -->
		<link rel="stylesheet" type="text/css" href="css/leafletksp.css" />
		<link rel="stylesheet" href="css/jKSPWAPICore.css" />
		<script type="text/javascript" src="js/leafletksp.js"></script>
		<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
		<script type="text/javascript" src="js/jKSPWAPICore.js"></script>
		<script>
    	var UpdateMarkerJSON = JSON.parse('{"Main":{"Debris":{"ID":[[10,10, "GILLY", "1000/10", 3000, "NOT A REAL SHIP", "Rock"]]},"Vessels":{"ID":[[-10,-10, "GILLY", "100/10", 3000, "NOT A REAL SHIP", "Boat"]]}}}')
        
    async function startMapUpdate() {
        while (true) {
        	const result = await updateMap();
  			resetMap()
  			try {
  			UpdateMarkerJSON.Main.Debris.ID.forEach((element) => {
 				var Heights = element[3].toString().split("/")
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.DEBRIS}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Type: " + element[6] + "<br>Altitude: " + Math.round(Heights[0]) + "m / " + Math.round(Heights[1]) + "m<br>Velocity: " + Math.round(element[4]) + "m/s<br>Type: " + element[6])]; 
 				//TODO: Replace eval with anything else
 				eval("newmarker[0].addTo(L.KSP.CelestialBody." + eval("element[2]") + ".overlays.Debris)")
			})
  			UpdateMarkerJSON.Main.Vessels.ID.forEach((element) => {
 				var Heights = element[3].toString().split("/")
 				var newmarker = [L.marker([element[0], element[1]], {icon: L.KSP.Icon.VESSEL}).bindPopup("<strong>" + element[5] + "</strong><br>" + Math.round(element[0]) + " : " + Math.round(element[1]) + "<br>Type: " + element[6] + "<br>Altitude: " + Math.round(Heights[0]) + "m / " + Math.round(Heights[1]) + "m<br>Velocity: " + Math.round(element[4]) + "m/s<br>Type: " + element[6])]; 
 				//TODO: Replace eval with anything else
 				eval("newmarker[0].addTo(L.KSP.CelestialBody." + eval("element[2]") + ".overlays.Vessels)")
			})
			} catch(e) {
			console.warn("ERROR BELOW")
			console.error(e)
			console.warn("JSON BELOW")
			console.warn(UpdateMarkerJSON)
			}
  		}
    }
    //TODO: Update existing markers instead of replacing.
    function resetMap() {
    	L.KSP.CelestialBody.EELOO.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.EELOO.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.POL.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.POL.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.BOP.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.BOP.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.TYLO.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.TYLO.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.VALL.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.VALL.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.LAYTHE.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.LAYTHE.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.DRES.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.DRES.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.IKE.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.IKE.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.DUNA.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.DUNA.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.MINMUS.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.MINMUS.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.MUN.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.MUN.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.KERBIN.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.KERBIN.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.GILLY.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.GILLY.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.EVE.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.EVE.overlays.Vessels.clearLayers()
		L.KSP.CelestialBody.MOHO.overlays.Debris.clearLayers()
		L.KSP.CelestialBody.MOHO.overlays.Vessels.clearLayers()
    }
    //Obtain JSON
    function updateMap() {
    return new Promise(resolve => {
    setTimeout(() => {
      var txtFile = new XMLHttpRequest();
    txtFile.onreadystatechange = function () {
    var allText = "";
        if (txtFile.readyState === XMLHttpRequest.DONE && txtFile.status == 200) {
        
            allText = txtFile.responseText;
            UpdateMarkerJSON = JSON.parse(allText);
}
        

    }
    txtFile.open("GET", 'https://jsonblob.com/api/jsonBlob/e7be982b-7620-11ea-84c8-85d74a3e24e7', true);
    txtFile.send(null);
      resolve(UpdateMarkerJSON);
    }, 2000);
  });
    }
    
    function sleep(ms)
	{
    	var date = new Date();
  	  var curDate = null;
 	   do { curDate = new Date(); }
  	  while(curDate-date < ms);
	}
	
    //I have not touched this much
        function startMap() {
            var previousBody = -1;
            var newBody;
            jQuery(document).ready(function ($) {
                map = new L.KSP.Map('map', {
                    layers: [L.KSP.CelestialBody.KERBIN],
                    zoom: 1,
                    center: [-0.1027, -74.5754],
                    bodyControl: true,
                    layerControl: false,
                    scaleControl: true
                });
                map.fitWorld();
                rawData = [[0]];
                var i = 0;
				resetMap()
				startMapUpdate()
				//Was used in telemachus, it might have something to do with orbit lines (looks like it requires long, lat, surface velocity though).
                /*jKSPWAPI.initPoll("longs=v.long&lat=v.lat&name=v.name&alt=v.altitude&m=v.surfaceVelocity&body=v.body", function (rawData) { }, function (rawData, d) {

                    if (previousBody != d.body) {
                        try {
                            newBody = L.KSP.CelestialBody[d.body.toUpperCase()];
                            newBody.addTo(map);
                            previousBody = d.body;
                        } catch (e) {
                            if (d.body === undefined) {
                                previousBody = d.body;
                            } else {
                                //alert("Body not supported yet. (" + d.body + ")")
                                previousBody = -1;
                            }
                            
                        }
                    }

                    if (!isNaN(d.lat) && !isNaN(d.longs)) {
                        marker[0].setLatLng([d.lat, (d.longs > 180 ? d.longs - 360.0 : d.longs)]);
                        marker[0].bindPopup(d.name + " 
									</br>Altitude: " + d.alt + "
								</br>Surface Velocity: " + d.m);
                        marker[0].update();
                    }
                }, rawData)*/
            });
        }
    
							</script>
						</head>
						<body onload="startMap();" style="padding: 0; margin: 0;">
							<div id="map" class="map" style="padding: 0; margin: 0; height: 100%;"></div>
						</body>
					</html>
